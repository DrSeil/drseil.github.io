<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ironmob - Coming Soon</title>
</head>
<style>
    .twitch .twitch-video {
  padding-top: 56.25%;
  position: relative;
  height: 0;
}

.twitch .twitch-video iframe {
  position: absolute;
  width: 100%;
  height: 100%;
  top: 0;
}
.twitch .twitch-chat {
  height: 400px;
}

.twitch .twitch-chat iframe {
  width: 100%;
  height: 100%;
}
@media screen and (min-width: 850px) {
  .twitch {
    position: relative;
  }

  .twitch .twitch-video {
    width: 75%;
    padding-top: 42.1875%;
  }

  .twitch .twitch-chat {
    width: 25%;
    height: auto;
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
  }
}
.twitch .twitch-chat.hidden {
  display: none;
}

</style>
<body>
  <header>
    <h1>Ironmob</h1>
    <h2>Coming Soon</h2>
  </header>
  <div class="twitch">
    <div class="twitch-video">
      <iframe
      id="twitch-video"
        src="https://player.twitch.tv/?channel=grandpoobear&parent=localhost&autoplay=false"
        frameborder="0"
        scrolling="no"
        allowfullscreen="true"
        height="100%"
        width="100%">
      </iframe>
    </div>
    <div class="twitch-chat">
      <iframe
        frameborder="0"
        scrolling="no"
        src="https://www.twitch.tv/embed/grandpoobear/chat?parent=localhost"
        height="100%"
        width="100%">
      </iframe>
    </div>
    <button id="toggle-chat">Toggle Chat</button>

  </div>
  <button id="twitch-link-button">Link to Twitch</button>
  <div id="moveable">
    <div id="pokeball-container">
      <img id="pokeball-image" src=".\static-pokeball.png" style="display: block;">
      <img id="pokeball-gif" src=".\pokeball.gif" style="display: none;"><div id="ready-text"></div>
      <p id="pokeball-text">
        If the pokeball is moving, you are eligible to be the trainer in GPB vs Chat Ironmon. If the pokeball isn't moving, either chat or gift/renew your subscription to GPB to become eligible. Click and drag the pokeball to move the extension.  Click this message to hide the text.
      </p>
    </div>
    <div id="countdown-div" style="display: none;">
      <p id="countdown-text">You are one of the next X trainers, please ready up within the next YY seconds</p>
      <button id="ready-up">Ready Up</button>
      <button id="skip-me">Skip Me</button>
    </div>
    <div class="primary">
      <div class="title">
        <div class="pokemon">
          <h1 id="name" class="name"></h1>
          <div id="types">
            <div id="type0" class='type-icon'></div> 
            <div id="type1" class='type-icon'></div> 
          </div>
        </div>
        <div class="health">
          HP: <span class="current-health"></span> / <span class="max-health"></span>
        </div>
      </div>
      <div class="ability">
        <span id="ability"> </span>
      </div>
      <div id="stats" class="row">
        <div class= "column">
          <div class="column-stat">
            HP
          </div>
          <div class="column-value">
            <span class="max-health"></span>
          </div>
          <div class="column-stat">
            ATK
          </div>
          <div class="column-value">
            <span class="attack"></span>
          </div>
          <div class="column-stat">
            DEF
          </div>
          <div class="column-value">
            <span class="defense"></span>
          </div>
        </div>
        <div class="column">
          <div class="column-stat">
            SPA
          </div>
          <div class="column-value">
            <span class="special-attack"></span>
          </div>
          <div class="column-stat">
            SPD
          </div>
          <div class="column-value">
            <span class="special-defense"></span>
          </div>
          <div class="column-stat">
            SPE
          </div>
          <div class="column-value">
            <span class="speed"></span>
          </div>
        </div>
      </div>
      <div id="moves">
        <div class="grid-container">
          <button class="button" id="move0">
            <div class="move" >
              <div id="move0-category" class="move-category"></div>
              <div class="move-details">
                <div class="move-name">
                  <span id="move0-name"></span>
                </div>
                <div class="move-type">
                  <p id="move0-type" class='type-icon'></p>
                </div>
                <div class="move-details">
                  POW: <span id="move0-power" class="power"></span>
                  PP: <span id="move0-pp" class="pp"></span>
                </div>  
              </div>
            </div>
          </button>
          <button class="button" id="move1">
            <div class="move" >
              <div id="move1-category" class="move-category"></div>
              <div class="move-details">
                <div class="move-name">
                  <span id="move1-name"></span>
                </div>
                <div class="move-type">
                  <p id="move1-type" class='type-icon'></p>
                </div>
                <div class="move-details">
                  POW: <span id="move1-power" class="power"></span>
                  PP: <span id="move1-pp" class="pp"></span>
                </div>  
              </div>
            </div>
          </button>
          <button class="button" id="move2">
            <div class="move" >
              <div id="move2-category" class="move-category"></div>
              <div class="move-details">
                <div class="move-name">
                  <span id="move2-name"></span>
                </div>
                <div class="move-type">
                  <p id="move2-type" class='type-icon'></p>
                </div>
                <div class="move-details">
                  POW: <span id="move2-power" class="power"></span>
                  PP: <span id="move2-pp" class="pp"></span>
                </div>  
              </div>
            </div>
          </button>
          <button class="button" id="move3" >
            <div class="move" >
              <div id="move3-category" class="move-category"></div>
              <div class="move-details">
                <div class="move-name">
                  <span id="move3-name"></span>
                </div>
                <div class="move-type">
                  <p id="move3-type" class='type-icon'></p>
                </div>
                <div class="move-details">
                  POW: <span id="move3-power" class="power"></span>
                  PP: <span id="move3-pp" class="pp"></span>
                </div>  
              </div>
            </div>
          </button>
        </div>
      </div>
    </div>
    
  
  <div id="waiting" class="waiting">
    <img src=".\loading-loading-forever.gif" />
    <h3>Waiting for input from game</h3>
  </div>
</div>

  <script type="text/javascript" src="./script.ts"></script>
  <script type="text/javascript" src="eventsub.js"></script>

  <script>
/*const category_map = {"Special" : "s","Physical":"p","Status":"t"};
    const type_map = {
  "normal": "N",
  "fire": "F",
  "water": "W",
  "electric": "E",
  "grass": "G",
  "ice": "I",
  "fighting": "Fi",  // "F" conflicts with Fire
  "poison": "P",
  "ground": "Gr",  // "G" conflicts with Grass
  "flying": "Fl",  // "F" conflicts with Fire
  "psychic": "Ps",  // "P" conflicts with Poison
  "bug": "B",
  "rock": "R",
  "ghost": "Gh",  // "G" conflicts with Grass
  "dragon": "D",  // "D" is unique
  "dark": "Da",  // "D" conflicts with Dragon
  "steel": "S",
  "fairy": "Fa"   // "F" conflicts with Fire, "Fi" conflicts with Fighting
}

function encodePokemon(pokemon) {
  const stats = Object.values(pokemon.stats).join("-");
  const moves = pokemon.moves.map(move => [category_map[move.category], move.name,move.power,type_map[move.type],move.accuracy,move.pp].join(":"));
  return [
    pokemon.uid,
    pokemon.nature,
    pokemon.curHP,
    pokemon.name,
    stats,
    pokemon.types.map(type=>{return type_map[type]}).join("|"),
    moves.join("|"),
    pokemon.ability
  ].join(",");
}

const condensedData = encodePokemon({
  "uid": "U135753687",
  "nature": "Hasty",
  "curHP": 33,
  "name": "Dragonair",
  "stats": {
    "atk": 20,
    "hp": 33,
    "def": 17,
    "spa": 15,
    "spe": 20,
    "spd": 11
  },
  "types": [
    "dragon",
    "fire"
  ],
  "moves": [
    {
      "category": "Special",
      "name": "Psych Up",
      "power": "90",
      "type": "normal",
      "accuracy": "0",
      "pp": 10
    },
    {
      "category": "Status",
      "name": "Fake Tears",
      "power": "0",
      "type": "dark",
      "accuracy": "100",
      "pp": 20
    },
    {
      "category": "Physical",
      "name": "Jump Kick",
      "power": "70",
      "type": "fighting",
      "accuracy": "95",
      "pp": 3
    },
    {
      "category": "Status",
      "name": "Conversion 2",
      "power": "0",  
      "type": "normal",
      "accuracy": "0",
      "pp": 0
    }
  ],
  "ability": "Swift Swim"
});

console.log(condensedData) // U135753687,Hasty,33,Dragonair,20-33-17-15-20-11,dragon|fire,s:Psych Up:90:N:0:10|t:Fake Tears:0:Da:100:20|p:Jump Kick:70:Fi:95:3|t:Conversion 2:0:N:0:0,Swift Swim

const category_reverse = {"s" : "Special","p":"Physical","t":"Status"};
const type_reverse = {  // Inverted mapping for decoding type codes
  "N": "normal",
  "F": "fire",
  "W": "water",
  "E": "electric",
  "G": "grass",
  "I": "ice",
  "Fi": "fighting",
  "P": "poison",
  "Gr": "ground",
  "Fl": "flying",
  "Ps": "psychic",
  "B": "bug",
  "R": "rock",
  "Gh": "ghost",
  "D": "dragon",
  "Da": "dark",
  "S": "steel",
  "Fa": "fairy"
}

function decodePokemon(data) {
  const [uid, nature, curHP, name, stats, types, moves, ability] = data.split(",");
  return {
    uid,
    nature,
    curHP: parseInt(curHP),
    name,
    stats: Object.fromEntries(stats.split("-").map((stat, index) => [["atk", "hp", "def", "spa", "spe", "spd"][index], stat])),
    types: types.split("|").map(type => {return type_reverse[type]}),
    moves: moves.split("|").map(move => {
      const [category, name, power, type, accuracy, pp] = move.split(":");
      return { category: category_reverse[category], name, power: power === "0" ? power : parseInt(power), type: type_reverse[type], accuracy: accuracy === "0" ? parseInt(accuracy) : parseFloat(accuracy), pp: parseInt(pp) };
    }),
    ability
  };
}

// Decode the previously encoded data (condensedData) as an example
const decodedPokemon = decodePokemon(condensedData);

console.log(decodedPokemon)*/
    const chatDiv = document.querySelector('.twitch-chat');
    const toggleButton = document.getElementById('toggle-chat');
    const videoFrame = document.getElementById('twitch-video');

    // Get the URL parameters
    const urlParams = new URLSearchParams(window.location.search);

    // Check if there's a "stream" parameter
    const stream = urlParams.get('stream');

    let streamUrl = "https://player.twitch.tv/?channel=grandpoobear&parent=localhost&autoplay=false";
    if (stream) {
    streamUrl = `https://player.twitch.tv/?channel=${stream}&parent=localhost&autoplay=false`;
    }

    videoFrame.src = streamUrl;

    toggleButton.addEventListener('click', function() {
      chatDiv.classList.toggle('hidden');  // Toggles 'hidden' class
    });
    const twitch_link_button = document.getElementById('twitch-link-button');

    function generateRandomString(length) {
    let text = "";
    const possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

    for (let i = 0; i < length; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
    }
    return text;
    }

    function encodeScope() {
    const scope = "user:read:chat user:write:chat";
    return encodeURIComponent(scope);
    }

    twitch_link_button.addEventListener('click', function() {
    const state = generateRandomString(16); // Change 16 to your desired string length
    const encodedScope = encodeScope();
    localStorage.setItem('state',state);
    const url = `https://id.twitch.tv/oauth2/authorize?response_type=token&client_id=nst9a3hi1iioqv1p75ph1cbx9oridg&redirect_uri=http://localhost:8081&scope=${encodedScope}&state=${state}`;
    window.location.href = url;
    });

    // Set button style (optional)
    twitch_link_button.style.backgroundColor = "purple";
    twitch_link_button.style.color = "white";

    window.addEventListener('load', function() {
        const fragmentString = window.location.hash;

    // Remove the leading hash symbol (#)
        const fragmentParams = new URLSearchParams(fragmentString.substring(1));

        const accessToken = fragmentParams.get('access_token');
        const scope = fragmentParams.get('scope');
        const state = fragmentParams.get('state');
        const tokenType = fragmentParams.get('token_type');

        console.log('access_token:', accessToken);
        console.log('scope:', scope);
        console.log('state:', state);
        console.log('token_type:', tokenType);

    const storedState = localStorage.getItem('state');
    console.log(storedState)
    if (accessToken && state && state === storedState) {
        localStorage.setItem('access_token', accessToken);
        localStorage.removeItem('state'); // Remove state after successful use
        console.log('stored access token' + accessToken)
        processToken(accessToken);

    }
    });

    var client_id = 'nst9a3hi1iioqv1p75ph1cbx9oridg';
    var redirect = window.location.origin + '/twitch_misc/';
    var access_token = '';
    var socket_space = '';
    var session_id = '';
    var my_user_id = '';

    //ironmob_fanin  1068813693
    //ironmob_fanout  1068814053
    const fanout = "1068814053";
    const fanin = "1068813693";
    function addsimplelog(message) {
            console.log(message)
        }
        function log(message) {
            
            console.log( message);
        }


    if (document.location.hash && document.location.hash != '') {
        log('Checking for token');
        var parsedHash = new URLSearchParams(window.location.hash.slice(1));
        if (parsedHash.get('access_token')) {
            log('Got a token');
            processToken(parsedHash.get('access_token'));
        }
    }

    const category_reverse = {"s" : "Special","p":"Physical","t":"Status"};
    const type_reverse = {  // Inverted mapping for decoding type codes
    "N": "normal",
    "F": "fire",
    "W": "water",
    "E": "electric",
    "G": "grass",
    "I": "ice",
    "Fi": "fighting",
    "P": "poison",
    "Gr": "ground",
    "Fl": "flying",
    "Ps": "psychic",
    "B": "bug",
    "R": "rock",
    "Gh": "ghost",
    "D": "dragon",
    "Da": "dark",
    "S": "steel",
    "Fa": "fairy"
    }

    function decodePokemon(data) {
    const [uid, nature, curHP, name, stats, types, moves, ability] = data.split(",");
    return {
        uid,
        nature,
        curHP: parseInt(curHP),
        name,
        stats: Object.fromEntries(stats.split("-").map((stat, index) => [["atk", "hp", "def", "spa", "spe", "spd"][index], stat])),
        types: types.split("|").map(type => {return type_reverse[type]}),
        moves: moves.split("|").map(move => {
        const [category, name, power, type, accuracy, pp] = move.split(":");
        return { category: category_reverse[category], name, power: power === "0" ? power : parseInt(power), type: type_reverse[type], accuracy: accuracy === "0" ? parseInt(accuracy) : parseFloat(accuracy), pp: parseInt(pp) };
        }),
        ability
    };
    }

// Decode the previously encoded data (condensedData) as an example
const decodedPokemon = decodePokemon(condensedData);

    function processToken(token) {
        log('Got a token trying to get chats')
            access_token = token;

            twitch_link_button.style.display = 'none';//remove link to avoid relinks....

            fetch(
                'https://api.twitch.tv/helix/users',
                {
                    "headers": {
                        "Client-ID": client_id,
                        "Authorization": `Bearer ${access_token}`
                    }
                }
            )
                .then(resp => resp.json())
                .then(resp => {
                    console.log(resp)
                    socket_space = new initSocket(true);
                    // and build schnanaigans
                    socket_space.on('connected', (id) => {
                        log(`Connected to WebSocket with ${id}`);
                        session_id = id;
                        my_user_id = resp.data[0].id;

                        requestHooks(fanout, my_user_id);
                        sendMessage("This is a test")

                        // extra/needed data
                    });

                    socket_space.on('session_silenced', () => {
                        addsimplelog('Session mystery died due to silence detected');
                    });
                    socket_space.on('session_keepalive', () => {
                        console.log("keepalive")
                    });
                    socket_space.on('revocation', ({ payload }) => {
                        let { event, subscription } = payload;
                        //let { subscription_type, subscription_version } = event;
                        let { status, condition, type } = subscription;
                        let { broadcaster_user_id } = condition;

                        addsimplelog(`On ${broadcaster_user_id} you were ${status} and ${type} was revoked`);
                    });

  

                    socket_space.on('channel.chat.message', ({ payload }) => {
                        let { event } = payload;

                        let { broadcaster_user_id, broadcaster_user_login, broadcaster_user_name } = event;
                        let { chatter_user_id, chatter_user_login, chatter_user_name } = event;
                        let { message_id, message, reply } = event;

                        let { text, fragments } = message;

                        if (text.startsWith("pkmn;")) {


                        // Split the data into parts using ';' as delimiter
                        const pokemon = text.slice(5); // Remove "pkmn;" and split by ','
                        console.log(decodePokemon(pokemon))

                        }


                        console.log(message)
                        console.log(event)
                    });


                })
                .catch(err => {
                    console.log(err);
                    log('Error with Users Call');
                });
        }



        function requestHooks(broadcaster_user_id, user_id) {
            let topics = {

                'channel.chat.message': { version: "1", condition: { broadcaster_user_id, user_id } },

            }

            log(`Spawn Topics for ${user_id}`);

            for (let type in topics) {
                log(`Attempt create ${type} - ${broadcaster_user_id} via ${user_id}`);
                let { version, condition } = topics[type];

                fetch(
                    'https://api.twitch.tv/helix/eventsub/subscriptions',
                    {
                        "method": "POST",
                        "headers": {
                            "Client-ID": client_id,
                            "Authorization": `Bearer ${access_token}`,
                            'Content-Type': 'application/json'
                        },
                        "body": JSON.stringify({
                            type,
                            version,
                            condition,
                            transport: {
                                method: "websocket",
                                session_id
                            }
                        })
                    }
                )
                    .then(resp => resp.json())
                    .then(resp => {
                        if (resp.error) {
                            log(`Error with eventsub Call ${type} Call: ${resp.message ? resp.message : ''}`);
                        } else {
                            log(`Created ${type}`);
                        }
                    })
                    .catch(err => {
                        console.log(err);
                        log(`Error with eventsub Call ${type} Call: ${err.message ? err.message : ''}`);
                    });
            }
        }

const message = "Hello, world! twitchdevHype";


function sendMessage(message){
    const url = 'https://api.twitch.tv/helix/chat/messages';
    const accessToken =  localStorage.getItem('access_token');


    const data = {
    broadcaster_id: fanin,
    sender_id: my_user_id,
    message: message
    };
    console.log(data)
    fetch(url, {
    method: 'POST',
    headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Client-Id': client_id,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
    console.log('Response:', data);
    })
    .catch(error => {
    console.error('Error:', error);
    });

}

        
  </script>
</body>
</html>
